<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>    
    <script src="libraries/shp.js"></script>
    
    <script src="libraries/d3.js" charset="utf-8"></script>
    <script src="ColorMapper.js"></script>
    <script src="js/exporter.js"></script>
    <script src="js/FileLoaderChloro.js"></script>
    <script src="js/LabelHandler.js"></script>
     <script src="http://maps.googleapis.com/maps/api/js"></script>
  
    
   <link rel="stylesheet" type="text/css" href="css/chloro.css">
    
    
  </head>
  <body>
    <script type="text/javascript">
        
    var infoContainer;
    var circle;   
     
        
        
        
    var metric;
    var fillcolor;
      
   
    var strokecolor;
    var strokewidth;
    var opacity;
    
    var zoom;
    var dataset;
    var geojsonFile;
    var file;
    
    
    var svg;
   
    var lbl;
    var projection;
    var path;
    var scale;
     var width = 2000,height = 2000;
     var headerNames;
     var barchart;
     
     var map;
     var g;
     
     var overlay;
     var layer;
     var gm_d3_map;
     var gm_projection ;
      var gm_path;
     
     var tooltipDiv;
     var bodyNode = d3.select('body').node();
     
     function gmapload() {
            var mapProp = {
              center:new google.maps.LatLng(7,81),
              zoom:5,
              mapTypeId:google.maps.MapTypeId.ROADMAP
            };
            map=new google.maps.Map(document.getElementById("googlemap"),mapProp);
            
            
            
          }
         
     
     function exportAsHTML(){
         
         
       var html = d3.select("svg")
        .attr("title", "test2")
        .attr("version", 1.1)
        .attr("xmlns", "http://www.w3.org/2000/svg")
        .node().parentNode.innerHTML;

        document.getElementById("downloadwindow").style.display='inline';

    d3.select("#downloadwindow").append("div")
        .attr("id", "download")
        .style("top", event.clientY+20+"px")
        .style("left", event.clientX+"px")
        .html("Right-click on this preview and choose Save as<br />Left-Click to dismiss<br />")
        .append("img")
        .attr("src", "data:image/svg+xml;base64,"+ btoa(html));

    d3.select("#download")
        .on("click", function(){
            if(event.button == 0){  //left mouse
                d3.select(this).transition()
                    .style("opacity", 0)
                    .remove();
            document.getElementById("downloadwindow").style.display='none';
            
            }
        })
        .transition()
        .duration(100)
        .style("opacity", 1);

      
     }
    
     
    function setMapProperties(){
         
        strokecolor =document.getElementById('strokecol').value;
        strokewidth = document.getElementById('strokewid').value;
        fillcolor = document.getElementById('fillcol').value;
        opacity = document.getElementById('opacit').value;
        
        g.attr("stroke",strokecolor)
            .attr("stroke-width",strokewidth)
            .attr("opacity",opacity)
            .selectAll("path")
            .style("fill",function(d){
                        // get the data value
                       var val = d.properties.Value;
                       var col = getColour(val);
                        return col;
                    });
     }
     
     function loadMetrics(){
          d3.select("#selectmetric")
                 .selectAll("options")
                 .data(headerNames)
                 .enter()
                 .append("option")
                 .attr("value", function(d){ return d })
                 .text(function(d) {
                     
                     if(d === headerNames[0]){
                         
                     }else{
			d = d[0].toUpperCase() +
				d.substring(1,3) + "" + 
					d.substring(3);
			return d
			
                    } });
     }  
     
     function selectMetric(){   
         
         if(geojsonFile == undefined){
             alert("Shapefile is unavailable or corrupted");
             console("datafile unavailble");
         }        
          else if(dataset == undefined){
             alert("Data file is unavailable or corrupted");
             console.log("dataset unavailable");
         }else{
         
         var obj = document.getElementById("selectmetric");   
         metric = obj.options[obj.selectedIndex].text;
         console.log("*"+metric+"*");
         
          loadVisualization(); 
         }
     }    
     
     
   
     
    
   
       function mapData(){
     
       for(var i=0;i<dataset.length;i++){
                    for(var i=0;i<dataset.length;i++){
                    //iterate through each district in data file
                    var districtName = dataset[i][headerNames[0]];

                  

                    //Grab data value, and convert from string to float
                    var dataValue = parseFloat(dataset[i][metric]);               


                    //Get the corresponding district from geoJson file

                    for(var j=0;j<geojsonFile.features.length;j++){

                        var geoDistrict = geojsonFile.features[j].properties.NAME_1;
                      
                        if(geoDistrict == districtName){
                            
                            
                            //assign a new variable to geojson object containing data value                         
                            geojsonFile.features[j].properties.Value = dataValue;

                        }                   


                    }
                }      
       }  
       
       
    }
          

    function loadVisualization(){

    console.log("Visualizing started");
    
            mapData();
            
            gmapload();
            
          
                  
                 //create the svg element 

               overlay = new google.maps.OverlayView();
              
               
                
                overlay.onAdd =  function (){
                   console.log("overlayadd_start");
                 layer = d3.select(this.getPanes().overlayMouseTarget)
                        .append('div') 
                        .append("id","mapContainer")
                        .append('svg')
                        .attr('width', 1000)
                        .attr('height', 1000) 
                        .style("fill","#0B1907");

                  g = layer.append("g");
                  
                  overlay.draw = function(){
                    console.log("overlaydraw_start");
              
                        gm_projection = overlay.getProjection();
                       
                       function gm_d3_map_proj(coordinates){
                          // console.log("coordinate_convo");
                                var google_coordinates = new google.maps.LatLng(coordinates[1],coordinates[0]);
                                var pixel_coordinates = gm_projection.fromLatLngToDivPixel(google_coordinates);

                                return [pixel_coordinates.x,pixel_coordinates.y];

                        }

                        gm_path = d3.geo.path().projection(gm_d3_map_proj);
                        
                    
                        
                         gm_d3_map= g.selectAll("path")
                               .data(geojsonFile.features)
                               .attr("d",gm_path)
                               .enter().append("svg:path")
                               .attr("class","svg")
                               .style("fill",function(d){
                                     // get the data value
                                    var val = d.properties.Value;
                                    var col = getColour(val);
                                   
                                     return  col;
                                 })
                                 .on("mouseover", function(d){
                                    console.log("mouseOver");
                                    //remove previous tooltip
                                     d3.select('body').selectAll('div.tooltip').remove();
                                     // Append tooltip
                                     tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
                                     var absoluteMousePos = d3.mouse(this);
                                     tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                                         .style('top', (absoluteMousePos[1] +10)+'px')
                                         .style('position', 'absolute') 
                                         .style('z-index', 1001);
                                     // Add text to tooltip
                                    if(d.properties.Value === undefined){
                                        tooltipDiv.html(d.properties.NAME_1+"<br/>"+"unavailable");
                                    }else{
                                     tooltipDiv.html(d.properties.NAME_1+"<br/>"+d.properties.Value);
                                     }
                                    })
                                    .on("mouseout",function(d){
                                    // Remove tooltip
                                    tooltipDiv.remove();

                                    })
                                        
                                        
                       ;

                       
                       
                        
                
                console.log("overlaydraw_end");
               };      
                  
                  console.log("overlayadd_end");
             };

            
               overlay.onRemove = function(){
                   console.log("remove");
               }   ;
              
                       
              overlay.setMap(map); 
          


            
            





    }
    
    
   
   
   function loadbarchart(){
         
        
               circle.style("fill",function() {
                        return "hsl(" + Math.random() * 360 + ",100%,50%)";
                        })
                       .html(function(d){
                           
                          return "abcd";
                           
               });
     }
    
    
   
    

   

    </script>
    <h1>The Visuvalizer</h1>
    
     
      <div id="map-editor" align="left">
     
        <br><br>
     
            <div id="shpInput">
                  <input type="File" id="shpFileInput">
                  <button id="uploadShp" onclick="shpload()">Upload Shapefile</button>
            </div>
        <br><br>
     
            
            <div id="csvInput">
                   <input type="File" id="csvFileInput">
                   <button id="uploadShp" onclick="loadCSV()">Upload CSV</button>
           </div>

        <br><br>
     
        <select id="selectmetric"></select>
        <button id="metric" onclick="selectMetric()">Select</button>

        <br>
           
           Fill Color:
           <input type="color" id="fillcol" ><br/><br/>
           Opacity :
           <input type="range" id="opacit" min=0 max=1 step=0.1><br/><br/>
           Border Color:
           <input type="color" id="strokecol"><br/><br/>
           Border Width:
           <input type="number" id="strokewid" ><br/><br/>
           
           <div id="option">
            <input name="updateButton" 
                 type="button" 
                value="Update" 
                onclick="setMapProperties()" /><br/>
            </div>
           <br/>
           
          
            <input id="label"  type="checkbox" onclick="handleLabelCheck()">Labels
           
          
            
             <br/><br/>
     
            <button id="export" onclick="exportAsHTML()">Export As Svg</button>
            <button id="exportPNG" onclick="exportAsPNG()">Export As PNG</button>
            
            <br><br>
            <button id="reset" onclick="reset()">Reset</button>
          
      </div>
          
            
            <div id="downloadwindow" align="center" display="none" class="white_content"></div>
             <div id="downloadwindowImg" align="center" display="none" class="white_content"></div>
            
            
            <div id="googlemap"></div>
            
            
           
             
    
     
  </body>
</html>