<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>    
    <script src="libraries/shp.js"></script>
    <script src="libraries/topojson.js"></script>
    <script src="libraries/d3.js" charset="utf-8"></script>
    <script src="libraries/d3.min.js"></script>
    
    <style>
        .subunit-label {
            fill: #0000;
            fill-opacity: .9;
            font-size: 10px;
            font-weight: 300;
            text-anchor: middle;
            }
            
        #info {
            position: absolute;
            left: 1000px;
            top: 300px;
            z-index: -1;
            }
    </style>
    
   
  </head>
  <body>
    <script type="text/javascript">
        
    var metric;
      
    var fillcolor ;
    var strokecolor;
    var strokewidth=3;
    var opacity;
    
    var zoom;
    var dataset;
    var geojsonFile;
    var file;
    
    
    var svg;
    var g;
    var lbl;
    var projection;
    var path;
    var scale;
     var width = 1000,height = 1000;
     var headerNames;
     
    
     
    function setMapProperties(){
         
        strokecolor =document.getElementById('strokecol').value;
        strokewidth = document.getElementById('strokewid').value;
        fillcolor = document.getElementById('fillcol').value;
        opacity = document.getElementById('opacit').value;
        
        svg.attr("stroke",strokecolor)
            .attr("stroke-width",strokewidth)
            .attr("opacity",opacity)
            .selectAll("path")
            .style("fill",function(d){
                        // get the data value
                       var val = d.properties.Value;
                       var col = getColour(val);
                        return col;
                    });
     }
     
     function loadMetrics(){
         
        
         
          d3.select("#selectmetric")
                 .selectAll("options")
                 .data(headerNames)
                 .enter()
                 .append("option")
                 .attr("value", function(d){ return d })
                 .text(function(d) {
			d = d[0].toUpperCase() +
				d.substring(1,3) + "" + 
					d.substring(3);
			return d
			});
         
     }  
     
     function selectMetric(){        
         
         var obj = document.getElementById("selectmetric");   
         metric = obj.options[obj.selectedIndex].text;
         
          loadVisualization(); 
     }    
     
    function loadFile(){
        
     file = document.getElementById('myFile').files[0];
    if (file) {
    d3.csv(file.name,function(error,data){
        //asynchronous method, rest of your code is executed even while JavaScript is simultaneously waiting for the file to finish downloading into the browser.
               
        if(error){
            console.log(error);
        }else{   
            dataset = data;
            headerNames = d3.keys(dataset[0]);
            loadMetrics();
                      
        }
    });
    }else{
        alert("dispaly error msg, invalid input");
        
    }
    
     
    
    
    }

    function loadVisualization(){



            //converting file to geoJson 
          shp("shapefiles/LKA_adm.zip").then(function(geoJson) {

                //merging csv data with geojson data
                geojsonFile = geoJson[1];




                for(var i=0;i<dataset.length;i++){
                    //iterate through each district in data file
                    var districtName = dataset[i][headerNames[0]];


                    //Grab data value, and convert from string to float
                    var dataValue = parseFloat(dataset[i][metric]);               


                    //Get the corresponding district from geoJson file

                    for(var j=0;j<geojsonFile.features.length;j++){

                        var geoDistrict = geojsonFile.features[j].properties.NAME_1;

                        if(geoDistrict == districtName){
                            //assign a new variable to geojson object containing data value                         
                            geojsonFile.features[j].properties.Value = dataValue;

                        }                   


                    }
                }        


                 //create the svg element 



                scale = 5000;

                projection = d3.geo.mercator()
                    .center([81,6.5]) //replace with the centroid
                    .scale(scale)    //scale and translate should be adjusted as suitable
                    .translate([width/2,height/2]);

                path = d3.geo.path()
                    .projection(projection);
            
                


                 svg = d3.select('#map').append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    ;
                    
                  g = svg.append("g");

                g.selectAll("path")
                        .data(geojsonFile.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("stroke",strokecolor)
                        .attr("stroke-width",strokewidth)
                        .attr("opacity",opacity)
                        .on("mouseover", function(){
                            d3.select(this).style("fill", "#FFFF00");
                            })
                        .on("mouseout",function(d){
                             var val = d.properties.Value;
                             var col = getColour(val);
                            d3.select(this).style("fill",col);
                            })
                        .on("click",function(d){                       
                            d3.select("#info").html(d.properties.NAME_1+"\n"+d.properties.Value);

                            })
                        .style("fill",function(d){
                            // get the data value
                           var val = d.properties.Value;
                           var col = getColour(val);

                            return col;
                        }) 
                       ;
                     

            //adding the csv value to the 
            
            lbl =  svg.selectAll(".subunit-label")
                  .data(geojsonFile.features)
                    .enter().append("text")
                    .attr("class", function(d) { return "subunit-label " + d.id; })
                    .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
                    .attr("dy", ".35em")
                    .text(function(d) { 
                        
                        if(d.properties.Value === undefined){
                            return d.properties.NAME_1;
                         }
                        else{
                             return d.properties.NAME_1+"\n"+d.properties.Value;
                        }
                    });
            
            
            zoom = d3.behavior.zoom()   //creates event listeners
                    .on("zoom",function() {
                g.attr("transform","translate("+ 
                    d3.event.translate.join(",")+")scale("+d3.event.scale+")");
                g.selectAll("path")  
                    .attr("d", path.projection(projection)); 
                
                });

            svg.call(zoom);



            });






    }
    
    function addLabels(){
        
        
         
        
    }
    
    
    
    
    function getColour(value){


        //get colour method is called multiple times
        if(value === undefined){
           //the default color will be displayed
           return "#424242" ;
        }else{

             var val = (value- min())/(max()-min());
            if(fillcolor === undefined){
                //return blue color as the default color
                return rgba(0,0,153,val);
            }else{        
             //converting hex fill col to decimal         
             var r =parseInt((fillcolor).substring(1,3).toString(16),16);  
             var g =parseInt((fillcolor).substring(3,5).toString(16),16);  
             var b =parseInt((fillcolor).substring(5,7).toString(16),16);  

            return rgba(r,g,b,val);
            }
        }

    }

    function rgba(r, g, b,a){

      r = Math.floor(r);
      g = Math.floor(g);
      b = Math.floor(b);
      return ["rgba(",r,",",g,",",b,",",a,")"].join("");
    }

    function max(){
        //return the max value of the data set
        var max = -Infinity;

       d3.selectAll("path")
               .each(function(d){
                   if(max < d.properties.Value){
                       max =d.properties.Value;
                   } 
                });

        return max;
    }

    function min(){
        //return the min value of the dataset
       var min = Infinity;

       d3.selectAll("path")
               .each(function(d){
                   if(min> d.properties.Value){
                       min =d.properties.Value;
                   } 
                });

        return min;
    }

    
    

   

    </script>
    <h1>The Visuvalizer</h1>
    
    
    
     
     
     
     <br><br>
    
    <input type="file" id="myFile" name="files[]" />
            
     <button id="upload" onclick="loadFile()">Upload</button>

     <br><br>
     
     <select id="selectmetric"></select>
     <button id="metric" onclick="selectMetric()">Select</button>

    
           <form name="Map Properties">
           Fill Color:
           <input type="color" id="fillcol" >
           Opacity :
           <input type="range" id="opacit" min=0 max=1 step=0.1 default=0.8>
           Stroke Color:
           <input type="color" id="strokecol">
           Stroke Width:
           <input type="number" id="strokewid" >
           <div id="option">
            <input name="updateButton" 
                 type="button" 
                value="Update" 
                onclick="setMapProperties()" />
            </div>
           
           <button id="zoom" onclick="addLabels()">Labels</button>
    
           
           <div id="map" align="center" ></div>
            </form>
           
     <div id="info">
         
         <p></p>
         
         
     </div>
    
     
  </body>
</html>