<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>    
    <script src="libraries/shp.js"></script>
    <script src="libraries/topojson.js"></script>
    <script src="libraries/d3.js" charset="utf-8"></script>
    <script src="libraries/d3.min.js"></script>
    
   
  </head>
  <body>
    <script type="text/javascript">
      
    var fillcolor;
    var strokecolor="#ffffff";
    var strokewidth=3;
    var opacity=0.8;
    
    var dataset;
    var svg;
    var projection;
    var path;
    var scale;
     var width = 1000,height = 1000;
     
     
    
     
     
    function getMapProperties(fillcol,opacit,strokecol,strokewid){
         
         fillcolor=fillcol;
         opacity=opacit;
         strokecolor=strokecol;
         strokewidth=strokewid;
         
         loadVisualization();
        
     }
     
    
         
   
    d3.csv("LKA_data.csv",function(error,data){
        //asynchronous method, rest of your code is executed even while JavaScript is simultaneously waiting for the file to finish downloading into the browser.
               
        if(error){
            console.log(error);
        }else{   
            dataset = data;
            loadVisualization();            
        }
    });
    
    

function loadVisualization(){
    
     

        //converting file to geoJson 
      shp("shapefiles/LKA_adm.zip").then(function(geoJson) {
            
            //merging csv data with geojson data
            
            for(var i=0;i<dataset.length;i++){
                //iterate through each district in data file
                var districtName = dataset[i].District;
                
                //Grab data value, and convert from string to float
                var dataValue = parseFloat(dataset[i].Value);
                
                
                                
                //Get the corresponding district from geoJson file
                
                for(var j=0;j<geoJson[1].features.length;j++){
                    
                    var geoDistrict = geoJson[1].features[j].properties.NAME_1;
                    
                    if(geoDistrict == districtName){
                        //assign a new variable to geojson object containing data value                         
                        geoJson[1].features[j].properties.Value = dataValue;
                        
                    }                   
                  
                   
                }
            }           
             //create the svg element 

           
                
            scale = 8000;
                
            projection = d3.geo.mercator()
                .center([81,6.5]) //replace with the centroid
                .scale(scale)    //scale and translate should be adjusted as suitable
                .translate([width/2,height/2]);

            path = d3.geo.path()
                .projection(projection);


             svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("path")
                    .data(geoJson[1].features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("stroke",strokecolor)
                    .attr("stroke-width",strokewidth)
                    .attr("opacity",opacity)
                    .style("fill",function(d){
                        // get the data value
                 
                        var val = d.properties.Value;
                         
                       var col = getColour(val);
                       console.log(col);
                        return col;
                
                    });
        });
        
        
       

        

}

function getColour(value){
    
    
    //get colour method is called multiple times
    if(value === undefined){
       //the default color will be displayed
      
       return "#FE2EF7";
    }else{
         var val = (value- min())/(max()-min())*255;
         //this depends on fillcolor
        
    return rgb(val,0,0);
    }
     
}

function rgb(r, g, b){
    
  r = Math.floor(r);
  g = Math.floor(g);
  b = Math.floor(b);
  return ["rgb(",r,",",g,",",b,")"].join("");
}

function max(){
    //return the max value of the data set
    var max = -Infinity;
     
   d3.selectAll("path")
           .each(function(d){
               if(max < d.properties.Value){
                   max =d.properties.Value;
               } 
            });
    //console.log("max "+max);
    return max;
}

function min(){
    //return the min value of the dataset
   var min = Infinity;
     
   d3.selectAll("path")
           .each(function(d){
               if(min> d.properties.Value){
                   min =d.properties.Value;
               } 
            });
   // console.log("min "+min);
    return min;
}




   

    </script>
    <h1>The Visuvalizer</h1>
    
           <form name="Map Properties">
           Fill Color:
           <input type="color" name="fillcol" value="#ff0000">
           Opacity :
           <input type="range" name="opacit" min="0" max="1">
           Stroke Color:
           <input type="color" name="strokecol" value="#ffffff">
           Stroke Width:
           <input type="number" name="strokewid" min="1" max="10">
           <input type="submit" onclick="getMapProperties(fillcol,opacit,strokecol,strokewid);">
            </form>
           
    
    
  </body>
</html>